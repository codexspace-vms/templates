{% set perPackageManager = {
    "npm": {
        "packages": "pkgs.nodejs_20",
        "install": "npm install"
    },
    "bun": {
        "packages": "pkgs.bun",
        "install": "bun install"
    },
    "pnpm": {
        "packages": "pkgs.nodePackages.pnpm",
        "install": "pnpm install"
    },
    "yarn": {
        "packages": "pkgs.yarn",
        "install": "yarn install"
    },
}[packageManager]%}
{ pkgs, ... }: {
  # Use a stable channel with necessary Android tools
  channel = "stable-24.05";
  
  packages = [
    {{perPackageManager.packages}}
    pkgs.jdk17
    pkgs.gradle
    pkgs.android-tools
  ];

  # Environment variables
  env = {
    # Cordova needs to know where JAVA_HOME is
    JAVA_HOME = "${pkgs.jdk17}";
    ANDROID_HOME = "/home/user/android-sdk"; # Standard path in IDX
  };

  idx = {
    # Extensions for Cordova and Web Development
    extensions = [
      "vsmobile.cordova-tools"
    ];

    workspace = {
      # Setup commands - run only once when the workspace is created
      onCreate = {
        install = "{{perPackageManager.install}}";
        # CRITICAL: This runs inside the environment, so it has access to Android SDK
        setup-android = "npx cordova platform add android"; 
      };
      
      # Commands to run when the workspace starts/restarts
      onStart = {
        # 1. Wait for the emulator to be ready
        connect-device = ''
          adb -s localhost:5554 wait-for-device
        '';
        
        # 2. Deploy the app to the emulator
        run-android = ''
          npx cordova run android --emulator --noprepare
        '';
      };
    };

    # Preview configuration
    previews = {
      enable = true;
      previews = {
        # Android preview (Viewed via the Android Emulator)
        android = {
          command = ["tail" "-f" "/dev/null"];
          manager = "web";
        };
      };
    };
  };
}