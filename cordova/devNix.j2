{% set perPackageManager = {
    "npm": {
        "packages": "pkgs.nodejs_20",
        "install": "npm install"
    },
    "bun": {
        "packages": "pkgs.bun",
        "install": "bun install"
    },
    "pnpm": {
        "packages": "pkgs.nodePackages.pnpm",
        "install": "pnpm install"
    },
    "yarn": {
        "packages": "pkgs.yarn",
        "install": "yarn install"
    },
}[packageManager]%}
{ pkgs, ... }: {
  # Using unstable channel often provides better/newer Android tools support
  channel = "unstable";
  
  packages = [
    {{perPackageManager.packages}}
    pkgs.jdk17
    pkgs.gradle
    pkgs.android-tools
  ];

  # Sets environment variables in the workspace
  env = {
    JAVA_HOME = "${pkgs.jdk17}";
  };

  idx = {
    extensions = [
      "vsmobile.cordova-tools"
    ];

    workspace = {
      onCreate = {
        install = "{{perPackageManager.install}}";
        # We skip 'prepare' here to avoid failures during creation if SDK isn't ready
      };
      
      onStart = {
        # 1. Connect to the emulator
        connect-device = ''
          adb -s localhost:5554 wait-for-device
        '';
        
        # 2. Build and run the app
        # We wrap this in a block to handle errors gracefully and prevent restart loops
        android = ''
          # Attempt to find the Android SDK root in the Nix store
          # This looks for the directory containing 'cmdline-tools'
          export ANDROID_HOME=$(find /nix/store -maxdepth 4 -type d -name "android-sdk" 2>/dev/null | head -n 1)
          
          if [ -z "$ANDROID_HOME" ]; then
            echo "ANDROID_HOME could not be found automatically."
            echo "Native builds might fail."
          else
            export ANDROID_SDK_ROOT=$ANDROID_HOME
            echo "Found Android SDK at: $ANDROID_HOME"
          fi

          # Run Cordova
          # We use '|| sleep infinity' to ensure that if Cordova crashes or fails,
          # the process doesn't exit, which prevents the "glitching" restart loop.
          npx cordova run android --emulator --noprepare || {
            echo "Cordova run failed. You may need to debug the native build."
            echo "You can still use the Web Preview."
            sleep infinity
          }
        '';
      };
    };
    
    previews = {
      enable = true;
      previews = {
        web = {
          command = ["npx" "cordova" "run" "browser" "--port" "$PORT"];
          manager = "web";
        };
        android = {
          command = ["tail" "-f" "/dev/null"];
          manager = "web";
        };
      };
    };
  };
}